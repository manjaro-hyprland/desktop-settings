#!/bin/sh
pacman_conf=/etc/pacman.conf
pacman_d_dir=/etc/pacman.d
custom_conf=$pacman_d_dir/manjaro-hyprland.repo.conf

custom_conf_exists() {
    [ -f $custom_conf ]
}
custom_conf_on_branch() {
    grep -q "/$(pacman-mirrors -G)" $custom_conf >/dev/null 2>&1
}
custom_conf_referenced() {
    grep -q "Include[ ]*=[ ]*$custom_conf" $pacman_conf
}
echo "## !!!!!! checking for custom repo configuration"
echo $(custom_conf_exists)
echo $(custom_conf_on_branch)
echo $(custom_conf_referenced)



if [ "$1" = "check" ]; then
    custom_conf_exists || exit 1
    custom_conf_on_branch || exit 1
    custom_conf_referenced || exit 1
    exit 0
fi
echo "passed!!!"


if [ "$(id -u)" -ne 0 ]; then
    echo "## Please run as root/sudo"
    exit 1
fi

# ensure pacman.d exists
mkdir -p $pacman_d_dir

if ! custom_conf_exists || ! custom_conf_on_branch; then
    cat >$custom_conf <<EOL
[manjaro-hyprland] 
SigLevel = PackageRequired
Server = https://pkg.manjaro-sway.download/$(pacman-mirrors -G)/\$arch 
EOL
    echo "## updated $custom_conf"
fi

echo $custom_conf

## remove the classic repo config
if grep -q "\[manjaro-hyprland\]" $pacman_conf; then
    sed -i '/\[manjaro-hyprland\]/,+2 d' $pacman_conf
    echo "## removed classic repo configuration from $pacman_conf"
fi

echo $custom_conf

## add a include line to the pacman.conf
if ! custom_conf_referenced; then
    sed -i "/^\[core\]/i \Include = $custom_conf\n" $pacman_conf
    echo "## now referencing $custom_conf from $pacman_conf"
fi

echo $custom_conf